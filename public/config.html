<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Custom Activity Mock</title>
    <script src="https://unpkg.com/postmonger"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        color: #333;
      }
      h2 {
        margin-bottom: 25px;
        color: #333;
      }
      .info-section {
        background-color: #f8f9fa;
        border-left: 4px solid #5bc0de;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
      }
      .field-info {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }
      .field-info:last-child {
        border-bottom: none;
      }
      .field-name {
        font-weight: bold;
        color: #0066cc;
        margin-bottom: 5px;
      }
      .field-desc {
        font-size: 14px;
        margin-top: 5px;
      }
      .note {
        background-color: #fffbd8;
        border-left: 4px solid #ffd24d;
        padding: 15px;
        margin-top: 25px;
        border-radius: 4px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <h2>Custom Activity Mock</h2>
    
    <div class="info-section">
      <p>Esta actividad realiza una llamada a un WS de Postman.</p>
    </div>
    
    <div class="field-info">
      <div class="field-name">Número de teléfono</div>
      <div class="field-desc">Se utilizará el campo <strong>MobilePhone</strong> de la Data Extension de entrada.</div>
      <div class="field-desc"><em>Debe contener números en formato internacional (ej: +34612345678)</em></div>
    </div>
    
    
    <div class="note">
      <strong>Nota:</strong> Asegúrese de que los campos necesarios existan en la Data Extension de entrada al Journey.
    </div>

    <script>
      // Iniciar comunicación con Journey Builder
      const connection = new Postmonger.Session();
      let payload = {};
      
      // Campos que queremos obtener de la DE
      const requiredFields = {
        phone: 'MobilePhone',
        message: 'SMSMessage',
        from: 'SMSFrom'
      };
      
      // Cuando se inicia la actividad
      connection.on("initActivity", function(data) {
        if (data) {
          payload = data;
          
          // Inicializar estructura de argumentos si no existe
          if (!payload.arguments) {
            payload.arguments = {};
          }
          if (!payload.arguments.execute) {
            payload.arguments.execute = {};
          }
          if (!payload.arguments.execute.inArguments) {
            payload.arguments.execute.inArguments = [];
          }
        }
        
        // Solicitar schema de entrada al journey
        connection.trigger('requestSchema');
        
        // Activar botón Done
        connection.trigger('updateButton', { button: 'next', enabled: true });
      });

      // Recibir schema y procesar campos
      connection.on('requestedSchema', function (data) {
        try {
          // Verificar si tenemos schema
          if (!data || !data.schema) {
            return;
          }
          
          const schema = data.schema;
          
          // Extraer el eventDefinitionKey (UUID del evento)
          // Formato ejemplo: Event.APIEvent-1a11c19c-7952-488a-99d7-069fa2bc543c.Id
          let eventDefinitionKey = "";
          
          if (Array.isArray(schema) && schema.length > 0) {
            // Tomar la primera key y extraer la parte del medio
            const firstKey = schema[0].key;
            
            const parts = firstKey.split('.');
            if (parts.length >= 2) {
              eventDefinitionKey = parts[1]; // Extraer el APIEvent-UUID
            }
          }
          
          // Limpiar inArguments existentes
          payload.arguments.execute.inArguments = [];
          
          // Crear objeto con argumentos
          const inArgs = {};
          
          // Guardar nombres de atributos
          inArgs.phoneAttribute = requiredFields.phone;
          inArgs.messageAttribute = requiredFields.message;
          inArgs.fromAttribute = requiredFields.from;
          
          // Si encontramos el eventDefinitionKey, crear bindings completos
          if (eventDefinitionKey) {
            inArgs.phone = `{{Event.${eventDefinitionKey}.${requiredFields.phone}}}`;
            inArgs.message = `{{Event.${eventDefinitionKey}.${requiredFields.message}}}`;
            inArgs.from = `{{Event.${eventDefinitionKey}.${requiredFields.from}}}`;
          } else {
            // Si no encontramos el eventDefinitionKey, usar un formato más simple
            inArgs.phone = `{{Event.Contact.Attribute.${requiredFields.phone}}}`;
            inArgs.message = `{{Event.Contact.Attribute.${requiredFields.message}}}`;
            inArgs.from = `{{Event.Contact.Attribute.${requiredFields.from}}}`;
          }
          
          // Agregar a inArguments
          payload.arguments.execute.inArguments.push(inArgs);
        } catch (error) {
          console.error("Error al procesar schema:", error);
        }
      });

      // Cuando se hace clic en Done/Next
      connection.on("clickedNext", function() {
        try {
          // Marcar como configurado
          if (!payload.metaData) {
            payload.metaData = {};
          }
          payload.metaData.isConfigured = true;
          
          connection.trigger("updateActivity", payload);
        } catch (error) {
          console.error("Error al guardar:", error);
        }
      });

      // Notificar que estamos listos
      connection.trigger("ready");
    </script>
  </body>
</html>