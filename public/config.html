<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Custom Activity Mock</title>
    <script src="https://unpkg.com/postmonger"></script>
    <style>
      :root {
        --brand-primary: #0070d2;
        --background-color: #f3f3f3;
        --card-background: #ffffff;
        --text-color: #181818;
        --label-color: #3e3e3e;
        --border-color: #dddbda;
        --border-radius: 0.25rem;
        --input-background: #ffffff;
        --info-background: #f3f9fe;
        --info-border: #0070d2;
        --note-background: #fff9e3;
        --note-border: #ffb75d;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--background-color);
        padding: 20px;
        color: var(--text-color);
        margin: 0;
      }

      #loader-container {
        text-align: center;
        padding-top: 50px;
        font-size: 16px;
        color: #666;
      }
      #loader-container.error {
        font-weight: bold;
        color: #c23934;
      }

      #form-container {
        display: none;
      }

      .header {
        padding-bottom: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
      }
      .header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
      }

      .form-section {
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .section-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--brand-primary);
        margin-top: 0;
        margin-bottom: 20px;
      }

      .form-field {
        margin-bottom: 20px;
      }
      .form-field:last-child {
        margin-bottom: 0;
      }

      .form-field label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--label-color);
      }
      
      .form-field input[type="text"],
      .form-field select {
        width: 100%;
        padding: 10px;
        font-size: 0.875rem;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        background-color: var(--input-background);
        box-sizing: border-box;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }
      .form-field input[type="text"]:focus,
      .form-field select:focus {
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 1px var(--brand-primary);
        outline: 0;
      }

      /* Custom arrow for select dropdowns */
      .form-field select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 0.7em top 50%, 0 0;
        background-size: 0.65em auto;
      }

      .field-desc {
        font-size: 0.8rem;
        margin-top: 8px;
        color: #545454;
      }
      
      .info-box {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: var(--border-radius);
        font-size: 0.875rem;
        border-left: 4px solid;
      }
      .info-box.info {
        background-color: var(--info-background);
        border-color: var(--info-border);
      }
      .info-box.note {
        background-color: var(--note-background);
        border-color: var(--note-border);
      }

    </style>
  </head>
  <body>    
    <!-- Contenedor para el mensaje de carga o error. Visible por defecto. -->
    <div id="loader-container">
      <p>Cargando configuración...</p>
    </div>

    <!-- Contenedor para todo el formulario. Oculto por defecto. -->
    <div id="form-container">
      <div class="header">
        <h2>Configuración de la Actividad</h2>
      </div>
      
      <div class="info-box info">
        <p>Configure los parámetros que se enviarán al servicio externo para cada contacto en el Journey.</p>
      </div>

      <!-- Sección de Configuración Estática -->
      <div class="form-section">
        <h3 class="section-title">Parámetros Estáticos</h3>
        <div class="form-field">
          <label for="text-input">Texto de Referencia</label>
          <input type="text" id="text-input" placeholder="Introduzca un valor de texto"/>
          <div class="field-desc">Este valor se enviará como 'customText' en los argumentos.</div>
        </div>
        
        <div class="form-field">
          <label for="template-picklist">Plantilla Fija</label>
          <select id="template-picklist">
            <option value="Template1">Template Fija 1</option>
            <option value="Template2">Template Fija 2</option>
            <option value="Template3">Template Fija 3</option>
          </select>
          <div class="field-desc">La plantilla seleccionada se enviará como 'selectedTemplate'.</div>
        </div>
      </div>

      <!-- Sección de Configuración Dinámica -->
      <div class="form-section">
        <h3 class="section-title">Parámetros Dinámicos</h3>
        <div class="form-field">
          <label for="template-de-picklist">Plantilla desde Data Extension</label>
          <select id="template-de-picklist">
              <option value="">-- Cargando templates... --</option>
          </select>
          <div class="field-desc">La plantilla seleccionada se guardará como 'selectedTemplateId'.</div>
          <div id="template-message-preview" style="margin-top: 10px; padding: 10px; background-color: #f3f3f3; border-radius: 4px; font-style: italic; display: none;">
              <strong>Mensaje:</strong> <span id="message-text"></span>
          </div>
        </div>

        <div class="form-field">
          <label for="de-field-picklist">Campo de la Fuente de Entrada</label>
          <select id="de-field-picklist">
              <option value="">-- Campos de la DE... --</option>
          </select>
          <div class="field-desc">
            Seleccione un campo de la Data Extension de entrada del Journey.
          </div>
        </div>
      </div>

      <div class="info-box note">
        <strong>Nota:</strong> Asegúrese de que los campos 'MobilePhone', 'SMSMessage' y 'SMSFrom' existan en la fuente de entrada del Journey.
      </div>
    </div>

    <script>
      // Iniciar comunicación con Journey Builder
      const connection = new Postmonger.Session();

      // Payload para pasarle a la actividad con la configuración
      let payload = {};
      
      // Almacenará los campos de la DE
      let schemaFields = [];

      // ALmacenará las plantillas para la picklist
      let deTemplates = []; 
      
      // Campos que queremos obtener de la DE. Se indican aquí para que, si luego se cambia el nombre, no se tenga que modificar en más sitios.
      const requiredFields = {
        phone: 'MobilePhone',
        message: 'SMSMessage',
        from: 'SMSFrom'
      };

      /*
        Los siguientes bloques son listeners que se ejecutan cuando los llama Journey Builder (on) o los requiere la app (trigger)
        https://developer.salesforce.com/docs/marketing/marketing-cloud/guide/using-postmonger.html
      */
      
      /* 
        Cuando se inicia la actividad (se arrastra la actividad al canvas o se hace click) se revisa si data contiene la configuración guardada.
        Si la tiene se pasa al payload y se monta la estructura que esta definida en el config.json
      */
      connection.on("initActivity", function(data) 
      {
        if (data) {
          payload = data;
        }
          
        /* Este bloque es una medida de seguridad. Se asegura de que la estructura payload.arguments.execute.inArguments 
            exista, incluso si la actividad es nueva 
          Si no se hiciera esto y se tratara de utilizar payload.arguments.execute.inArguments.push() (más adelante), 
          daría un error porque se está intentando acceder a una propiedad (push) de algo que no existe (undefined).
          En este caso, no se está guardando nada en el /save, por lo que es necesario definirlo.
        */
        if (!payload.arguments) {
          payload.arguments = {};
        }
        if (!payload.arguments.execute) {
          payload.arguments.execute = {};
        }
        if (!payload.arguments.execute.inArguments) {
          payload.arguments.execute.inArguments = [{}];
        } 
    
        // Solicitar schema de entrada al journey. Es decir, se solicita la lista de todos los campos disponibles en la DE de entrada.
        connection.trigger('requestSchema');       
        
      });

      /* 
        Este listener se dispara cuando MC envía el esquema de la DE.
        Su responsabilidad es:
        1. Rellenar el desplegable (picklist) con los campos de la DE.
        2. Cargar los datos guardados en el formulario.

        Se ha solicitado al cargar la actividad.

        El objetivo es construir los inArguments, que es la parte más importante del payload. 
        Los inArguments le indican al endpoint /execute de dónde sacar los valores datos.
      */
      connection.on('requestedSchema', function (data) {
        const loaderContainer = document.getElementById('loader-container');
        const formContainer = document.getElementById('form-container');

        try {
          // Verificar si tenemos schema
          if (!data || !data.schema || data.schema.length === 0) {
            loaderContainer.innerHTML = '<p>Debes configurar primero la entrada al Journey</p>';
            loaderContainer.className = 'error';
            formContainer.style.display = 'none';
            connection.trigger('updateButton', { button: 'next', enabled: false });
            return;
          }
          loaderContainer.style.display = 'none';
          formContainer.style.display = 'block';

          // Guardar el esquema para usarlo al guardar
          schemaFields = data.schema; 
          // Recupera la picklist de los valores de campos
          const deFieldSelect = document.getElementById('de-field-picklist');
          // Limpiar opciones
          deFieldSelect.innerHTML = ''; 

          // Crear y añadir la opción por defecto
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.innerText = '-- Seleccione un campo --';
          deFieldSelect.appendChild(defaultOption);

          // Rellenar el desplegable con los campos reales de la DE
          schemaFields.forEach(field => {
            const option = document.createElement('option');
            option.innerText = field.name; // Lo que ve el usuario (ej: "FirstName")
            option.value = `{{${field.key}}}`; // El valor guardado (ej: "{{Event.APIEvent-XYZ.FirstName}}")
            deFieldSelect.appendChild(option);
          });
          
          // Llamar a la función que rellena la lista de templates de la DE
          populateDETemplates();

          // Carga los datos del formulario después de construir el desplegable
          loadFormData();

          // Añadir el listener al desplegable para mostrar/ocultar la vista previa del mensaje
          document.getElementById('template-de-picklist').addEventListener('change', updateMessagePreview);

          /* Le decimos a Journey Builder que active el botón "Siguiente" / "Hecho". 
            Si no hicieras esto, el botón estaría deshabilitado y el usuario no podría guardar la configuración.
          */
          connection.trigger('updateButton', { button: 'next', enabled: true });
          
        } catch (error) {
          console.error("Error al procesar schema:", error);
        }
      });

      // Cuando se hace clic en Done/Next
      connection.on("clickedNext", function() {
        try 
        {
          // Recoge todos los datos del formulario
          saveFormDataToPayload(); 
          // Se le indica a Journey Builder que debe cerrar la ventana y que la configuración está lista
          connection.trigger("updateActivity", payload);
        } catch (error) {
          console.error("Error al guardar:", error);
        }
      });

      // Notificar que estamos listos. La primera vez que se usar el ready, JB llama a initActivity o initEvent.
      connection.trigger("ready");


    //  Función para poblar los templates desde la DE 
    /**
     * Llama al backend para obtener los templates de la DE y rellena la lista de selección.
     */
    async function populateDETemplates() {
      const select = document.getElementById('template-de-picklist');
      try {
        // La URL debe apuntar a tu servidor. En desarrollo puede ser relativa,
        // pero en producción debe ser la URL completa de tu app.
        const response = await fetch('/api/templates');
        if (!response.ok) {
          throw new Error(`El servidor respondió con estado ${response.status}`);
        }

        deTemplates = await response.json();

        select.innerHTML = ''; // Limpiar el mensaje de "Cargando..."
        
        if (deTemplates.length === 0) {
          select.innerHTML = '<option value="">-- No se encontraron templates --</option>';
          return;
        }

        // Añadir una opción por defecto
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.innerText = '-- Seleccione una plantilla --';
        select.appendChild(defaultOption);

        deTemplates.forEach(template => {
          const option = document.createElement('option');
          option.value = template.id;
          option.innerText = template.name;
          select.appendChild(option);
        });

        // Volver a cargar los datos del formulario por si la respuesta de la API llegó tarde
        loadFormData();

      } catch (error) {
        console.error('Error al cargar templates de la DE:', error);
        select.innerHTML = '<option value="">-- Error al cargar --</option>';
      }
    }

      /**
       * Lee los datos del 'payload' y los usa para rellenar los campos del formulario.
       * Esto asegura que al editar una actividad, el usuario vea su configuración anterior.
       */
      function loadFormData() {
        if (payload.arguments && payload.arguments.execute && payload.arguments.execute.inArguments.length > 0) 
        {
          const inArgs = payload.arguments.execute.inArguments[0];

          // Rellenar cada campo del formulario con el valor guardado o un valor por defecto
          document.getElementById('text-input').value = inArgs.customText || '';
          document.getElementById('template-picklist').value = inArgs.selectedTemplate || 'Template1';
          document.getElementById('de-field-picklist').value = inArgs.selectedDEField || '';

          const selectedTemplateId = inArgs.selectedTemplateId || '';
          document.getElementById('template-de-picklist').value = selectedTemplateId;
          
          // Si hay un template seleccionado al cargar, mostrar su mensaje
          updateMessagePreview();
        }
      }

      // Función para actualizar la vista previa 
      /**
       * Se ejecuta cada vez que el usuario cambia la selección del desplegable de templates.
       */
      function updateMessagePreview() {
        const select = document.getElementById('template-de-picklist');
        const previewContainer = document.getElementById('template-message-preview');
        const messageTextSpan = document.getElementById('message-text');
        
        const selectedId = select.value;

        // Si no hay nada seleccionado, ocultar la vista previa
        if (!selectedId) {
          previewContainer.style.display = 'none';
          return;
        }
        
        // Buscar el template seleccionado en nuestro array de templates guardados
        const selectedTemplate = deTemplates.find(t => String(t.id) === selectedId);

        if (selectedTemplate && selectedTemplate.message) {
          // Si encontramos el template y tiene un mensaje, lo mostramos
          messageTextSpan.innerText = selectedTemplate.message;
          previewContainer.style.display = 'block';
        } else {
          // Si no, ocultamos la vista previa (por si acaso)
          previewContainer.style.display = 'none';
        }
      }

      // Función para guardar los datos del formulario en el payload 
      /**
       * Recoge todos los valores actuales del formulario y los guarda en la estructura
       * 'inArguments' del payload.
       */
      function saveFormDataToPayload() {
        const inArgs = {};

        // Recoge los valores de los campos del formulario
        inArgs.customText = document.getElementById('text-input').value;
        inArgs.selectedTemplate = document.getElementById('template-picklist').value;
        inArgs.selectedDEField = document.getElementById('de-field-picklist').value;
        
        const selectedTemplateId = document.getElementById('template-de-picklist').value;
        inArgs.selectedTemplateId = selectedTemplateId;

        if (selectedTemplateId && deTemplates.length > 0) {
            const selectedTemplateObject = deTemplates.find(t => String(t.id) === selectedTemplateId);
            if (selectedTemplateObject) {
                // Guardamos la plantilla del mensaje SIN personalizar.
                inArgs.selectedTemplateMessage = selectedTemplateObject.message;
            }
        }

        // Añadir los valores "hard-coded" (phone, message, etc.) usando el esquema guardado
        // Extraer el eventDefinitionKey (UUID del evento)
        // Formato ejemplo de la Key: Event.APIEvent-1a11c19c-7952-488a-99d7-069fa2bc543c.Id
        let eventDefinitionKey = "";
        if (schemaFields.length > 0) {
          const firstKey = schemaFields[0].key;
          const parts = firstKey.split('.');
          if (parts.length >= 2) {
            eventDefinitionKey = parts[1];
          }
        }        
        
        /* 
          Si encontramos el eventDefinitionKey, crear bindings completos 
          Esto se podría indicar directamente en el config.json, pero en este caso los nombres
          de los campos de la DE siempre deberían ser los indicados en el archivo de configuración.
        */
        if (eventDefinitionKey) {
          inArgs.phone = `{{Event.${eventDefinitionKey}.${requiredFields.phone}}}`;
          inArgs.message = `{{Event.${eventDefinitionKey}.${requiredFields.message}}}`;
          inArgs.from = `{{Event.${eventDefinitionKey}.${requiredFields.from}}}`;
        } else {
          // Si no encontramos el eventDefinitionKey, se puede intentar recuperar de ContactData
          inArgs.phone = `{{Contact.Attribute.DataExtension.${requiredFields.phone}}}`;
          inArgs.message = `{{Contact.Attribute.DataExtension.${requiredFields.message}}}`;
          inArgs.from = `{{Contact.Attribute.DataExtension.${requiredFields.from}}}`;
        }

        // Reemplazar los argumentos en el payload con el nuevo objeto construido
        payload.arguments.execute.inArguments = [inArgs];

        // Marcar la actividad como configurada. Necesario para que JB permita activar
        if (!payload.metaData) {
          payload.metaData = {};
        }
        payload.metaData.isConfigured = true;
      }
    </script>
  </body>
</html>